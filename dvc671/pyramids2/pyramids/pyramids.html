<!DOCTYPE html>
<html lang="en">

<head>
   <!-- Google Tag Manager -->
	<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-MBCBVQS');</script>
    <!-- End Google Tag Manager -->

    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,600,700' rel='stylesheet' type='text/css'>
    <title>MYE Population estimates 2017 - population pyramids</title>

    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />

   <!-- <link rel="stylesheet" href="../css/bootstrap.min.css" />-->
    <link rel="stylesheet" href="../css/style-chosen.css">
    <link rel="stylesheet" href="../css/jquery.ui.labeledslider.css">
    <link rel="stylesheet" href="../css/jquery-ui-1.10.4.custom.min.css">
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/all.css" rel='stylesheet'>
    <link rel="stylesheet" href="../css/bootstrap-toggle.css">

    <script type="text/javascript" src="../lib/d3.v3.min.js" ></script>
    <script type="text/javascript" src="../lib/jquery-1.11.3.js"></script>
   	<script type="text/javascript" src="../lib/jquery-ui-1.9.2.custom.min.js"></script>

    <script type="text/javascript" src="../lib/modernizr.svg.min.js" ></script>
    <script type="text/javascript" src="../lib/chosen.jquery.js"></script>
 	<script type="text/javascript" src="../lib/bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdn.ons.gov.uk/vendor/pym/1.3.2/pym.min.js" ></script>
    <script type="text/javascript" src="../lib/jquery.ui.labeledslider.js"></script>
    <script type="text/javascript" src="../lib/bootstrap-toggle.js"></script>
 	<script type="text/javascript" src="../lib/jquery.ui.touch-punch.min.js"></script>
    <style type="text/css">

body{
	font-family: "Open Sans" !important;
	font-weight:400;
	max-width:940px;
	margin: 0px auto;
}

#graphic{

}

.selected{
	fill:#444444;
	fill-opacity:0.3
}

.unselected	{
	fill-opacity:0
}


/*#playPauseBtn{
	width:60px;
	height:60px;
	background:transparent url('../images/playBtn.png') center top no-repeat;
	opacity:0.7;
	cursor:pointer;
}

#playPauseBtn:hover{
	opacity:0.9;
}*/





.txtTotals{
	font-size:26px;
	font-weight:700;
}



#MFbars rect{
	fill:#8064A0;
	opacity:0.8;
}

#maleLabel0 text, #maleLabel1 text, #femaleLabel0 text, #femaleLabel1 text{
 font-weight: 600 !important;
}

.ageRow, .totalRow{
	height: 25px;
}

#infoValues0 span, #infoValues1 span{
	/*opacity:0;*/
}

#infoValues0, #infoPercent0, #infoValues1, #infoPercent1{
	font-size:16px;
}

#infoPercent0, #infoPercent1{
	text-align:right;
}

#infobold {
font-weight: 700;
}


#vizCanvas{

}


.domain{
	stroke:#B1B1B1;
	stroke-width:1px;
	fill:none;
}



.horizontal .ui-slider-labels{
	top:0.1em;
}



#graphContent text{
	font-weight:400;
	font-size:15px;
}


        #panel0, #panel1 {
        	fill:white;
        }

		.percent{padding-right:5px;}

.col-xs-1, .col-sm-1, .col-md-1, .col-lg-1, .col-xs-2, .col-sm-2, .col-md-2, .col-lg-2, .col-xs-3, .col-sm-3, .col-md-3, .col-lg-3, .col-xs-4, .col-sm-4, .col-md-4, .col-lg-4, .col-xs-5, .col-sm-5, .col-md-5, .col-lg-5, .col-xs-6, .col-sm-6, .col-md-6, .col-lg-6, .col-xs-7, .col-sm-7, .col-md-7, .col-lg-7, .col-xs-8, .col-sm-8, .col-md-8, .col-lg-8, .col-xs-9, .col-sm-9, .col-md-9, .col-lg-9, .col-xs-10, .col-sm-10, .col-md-10, .col-lg-10, .col-xs-11, .col-sm-11, .col-md-11, .col-lg-11, .col-xs-12, .col-sm-12, .col-md-12, .col-lg-12 {
    padding-left: 0px;
    padding-right: 0px;
}
#barChart0, #barChart1{
	padding-left:5px;
	padding-right:0px;
}


#MFbars0, #MFbars1{
	width:100%;
	height:40px;
}

#note{
	font-size:13px;
	font-weight:300;
}
#controls1{
	padding-bottom:15px;
}

.tick line{
	stroke:#b1b1b1;
}

#chartTitle{
	font-size:30px;
	font-weight:300;
}

#source{
	     font-size: 16px;
         margin: 16px 0 8px 0;
         font-weight: 700;
         color:#323132;
}

#sel0, #sel1 {
	height:50px;
}


.btn--primary {
   background-color: #206095 !important;
}

.btn {
   /*position: relative;*/
   padding: 10px 15px;
   margin: 0 0 20px;
   line-height: normal;
   color: #fff;
   font-size: 16px;
   border-radius: 0px;
   display: inline-block;
   text-rendering: optimizeLegibility;
   transition: background-color .2s ease-in, color .2s ease-in;
}
.btn--primary {
   background-color: #206095;
   color: #fff;
}
.btn {
   font-family: "Open Sans",Helvetica,Arial,sans-serif;
   font-weight: 400;
   font-size: 16px;
   display: inline-block;
   width: auto;
   cursor: pointer;
   padding: 6px 16px 10px 16px;
   border: 0 none;
   text-align: center;
   -webkit-appearance: none;
   transition: background-color 0.25s ease-out;
   text-decoration: none;
   line-height: 24px;
   margin-left:1px !important;
}

.btn:focus{
	box-shadow: 0 0 0px 3pt orange;
}

.ui-slider-handle:focus{
	box-shadow: 0 0 0px 3pt orange;
}

button {
   cursor: pointer;
}

.btn--secondary {
    background-color: #6D6E72;
    color: #fff;
}

.btn--play::after {
   font-family: "Font Awesome 5 Free";
   font-weight: 900;
   content: "\f144";
   margin-left: 10px;
}

.btn--pause::after {
   font-family: "Font Awesome 5 Free";
   font-weight: 900;
   content: "\f04c";
   margin-left: 10px;
}

.btn--next::after {
    font-family: "Font Awesome 5 Free";
    font-weight: 900;
    content: "\f054";
    margin-left: 10px;
}

.btn--previous::before {
    font-family: "Font Awesome 5 Free";
    font-weight: 900;
    content: "\f053";
    margin-right: 10px;
}

.toggle.btn {
    border: 1px solid #6D6E72;
}


@media(max-width:500px) {
	.btn {
		font-size: 14px;
		display: inline-block;
		width: auto;
		cursor: pointer;
		padding: 6px 4px 6px 4px;
	}
}

.visuallyhidden {
				position: absolute;
				width: 1px;
				height: 1px;
				margin: -1px;
				padding:0;
				overflow: hidden;
				clip: rect(0,0,0,0); border: 0;
				display:block !important;
		}

    </style>
</head>
<body>
<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-MBCBVQS"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->

<h5 class="visuallyhidden">This graphic allows users to explore and compare the shape of a population in two areas (by age and sex). See the accompanying data for the underlying figures. </h5
<div class="container-fluid" aria-hidden="true" role="presentation">
		<div class="allContent">
	        <div class="row">
               <!--<div id = "chartTitle">2014-based National Population Projections - Principal and Variants, 2014 - 2039</div>-->
	        	<div class="col-sm-5 col-xs-12 " id="dropdown0"></div>
	            <div class="col-sm-offset-1 col-sm-5 hidden-xs " id="dropdown1"></div>
	        </div>

	         <div class="row">
	        	<div class="col-sm-6 col-xs-12" id="txtTotals0"></div>
	            <div class="col-sm-6 hidden-xs" id="txtTotals1"></div>
							<div aria-live="polite" id="keyvaluehidden" class="visuallyhidden"></div>
	        </div>

	         <div class="row ageRow">
	        	<div class="col-sm-6 col-xs-12" id="age0"></div>
	            <div class="col-sm-6 hidden-xs" id="age1"></div>
	        </div>

	        <div class="row barcharts">
	        	<div class="col-sm-2 col-xs-6" id="infoValues0"></div>
	            <div class="col-sm-1 col-xs-2 text-right percent" id="infoPercent0"></div>
	            <div class="col-sm-3 col-xs-4" id="barChart0"><svg id="MFbars0"></svg></div>
	            <div class="col-sm-2 hidden-xs" id="infoValues1"></div>
	            <div class="col-sm-1 hidden-xs text-right percent" id="infoPercent1"></div>
	            <div class="col-sm-3 hidden-xs" id="barChart1"><svg id="MFbars1"></svg></div>
	        </div>

	        <div class="row totalRow">
	        	<div class="col-sm-6 col-xs-12" id="combinedTotal0"></div>
	            <div class="col-sm-6 hidden-xs" id="combinedTotal1"></div>
	        </div>

	        <div class="row" id="graphic"></div>

            	<div class="row" id="controls1" ></div>
                <div class="row" id="controls2">
										<fieldset>
											<legend class="visuallyhidden">Secondary population pyramid controls</legend>
											<label class="visuallyhidden" for="outlinesToggle">Toggle pyramid outline for current time period</label>
											<input type="checkbox" id="outlinesToggle">
											<label class="visuallyhidden" for="overlapToggle">Toggle pyramid overlap to compare areas</label>
											<input type="checkbox" id="overlapToggle">
											<label class="visuallyhidden" for="dimensionsToggle">Toggle between percentage of population and number of people</label>
											<input type="checkbox" id="dimensionsToggle">
											<button aria-label="Clear selection" type="button" id="clearBtn" class="btn btn--secondary btn-xs" disabled="disabled">Clear selection</button>
										</fieldset>
                </div>
             <div class="row" id="source">Office for National Statistics, Northern Ireland Statistics and Research Agency, National Records of Scotland and Welsh Government</div>
		</div>
	</div>



    <script>

    	//globals
		var dvc ={};//global namespace

					margin_top = 30,
					margin_left = 20,
					margin_bottom = 80,
					margin_right = margin_left,
					dvc.aspectRatio_sm =  [6,3],
            		dvc.aspectRatio_md = [6,3],
            		dvc.aspectRatio_lg = [6,3],
					dvc.nodata =["Antrim and Newtownabbey", "Armagh City, Banbridge and Craigavon", "Belfast", "Causeway Coast and Glens", "Derry City and Strabane", "Fermanagh and Omagh", "Lisburn and Castlereagh", "Mid and East Antrim", "Mid Ulster", "Newry, Mourne and Down", "Ards and North Down"]

					dvc.scotland =["Clackmannanshire", "Dumfries and Galloway", "East Ayrshire", "East Lothian", "East Renfrewshire", "Na h-Eileanan Siar", "Falkirk", "Fife", "Highland", "Inverclyde", "Midlothian", "Moray", "North Ayrshire", "Orkney Islands", "Perth and Kinross", "Scottish Borders", "Shetland Islands", "South Ayrshire", "South Lanarkshire", "Stirling", "Aberdeen City", "Aberdeenshire", "Argyll and Bute", "City of Edinburgh", "Renfrewshire", "West Dunbartonshire", "West Lothian", "Angus", "Dundee City", "North Lanarkshire", "East Dunbartonshire", "Glasgow City"]

					dvc.ageover85 =["86", "87", "88", "89", "90+"]



					dvc.cenGap=14;//central gap between 2 histograms in a pyramid
					dvc.chartColors=["#5F7682","#008080"];

					//derived variables

					dvc.maxValues=[0,0];//initialise max Values for two charts

					//selection settings
					dvc.selMade=false;//is there a selection
					dvc.selProc=false;//is the selection process for aggregates underway?
					//dvc.selStart;
					//dvc.selEnd;

					//animation settings
				//	dvc.nSpeed=1000;
					dvc.timeLength;
					//dvc.timeIndex=0;
					dvc.bAnimate=false;
					dvc.bLoop=true;


					//round to nearest 100
					dvc.roundTo=1;



		var graphic = $('#graphic');
		var keypoints = $('#keypoints');
		var footer = $(".footer");
		var pymChild = null;

		function drawGraphic(width) {
		  dvc.threshold_md = 788;
		  dvc.threshold_sm = 758;
		  dvc.threshold_ipad_extra = 600;

		  	//set variables for chart dimensions dependent on width of #graphic
		    if (graphic.width() < dvc.threshold_ipad_extra) {
		           	var width = graphic.width() ;
		            var height = Math.ceil((width * dvc.aspectRatio_sm[1]) *2/ dvc.aspectRatio_sm[0]) ;
		    } else if (graphic.width() < dvc.threshold_sm) {
		           	var width = graphic.width()*0.75 ;
		            var height = Math.ceil((width * dvc.aspectRatio_sm[1]) *2/ dvc.aspectRatio_sm[0]) ;
		    } else if (graphic.width() < dvc.threshold_md){
		        	var width = graphic.width() ;
		            var height = Math.ceil((width * dvc.aspectRatio_md[1]) / dvc.aspectRatio_md[0]) ;
		  	} else {
		        	var width = graphic.width() ;
		            var height = Math.ceil((width * dvc.aspectRatio_lg[1]) / dvc.aspectRatio_lg[0]) ;
			}

			if(graphic.width() < dvc.threshold_sm){
					dvc.panelWidth=width-margin_left-margin_right;//width of a single chart panel
					dvc.panelHeight=height - margin_top - margin_bottom;

			} else {
					//gap between the 2 charts
					dvc.panelGap=width/4;

					dvc.panelWidth=(width/2-(margin_left+margin_right))-dvc.panelGap/2;//width of a single chart panel
					dvc.panelHeight=height - margin_top - margin_bottom;

			}

			dvc.xAdjust=50;


//			//if no parameters set in url
//			dvc.timeIndex=dvc.settings.config.timeDefault;//assign default starting period
//			dvc.defaultSelections=dvc.settings.config.defaultVars;
//			dvc.selStart =	null;
//			dvc.selEnd 	= null;
//			dvc.overlap =	false;
//			dvc.lockOutlines =	false;
//			dvc.LockedYear = 'na';
//			dvc.outlineIndex ='na';
//			dvc.varDimension=dvc.settings.config.defaultConcept;//used to switch between count and % data elements

		    // clear out existing graphics
		    d3.select("#graphic").selectAll('*').remove();
			keypoints.empty();
			footer.empty();
			$("#dropdown0").empty();
			$("#dropdown1").empty();


			//create first simple scale
			dvc.xScale=d3.scale.linear()
				.domain([0,dvc.maxdvc])
				.range([0,(dvc.panelWidth/2)-dvc.cenGap])
				.nice();

			//a scale object to define the inverted axis of the left hand side of pyramid [higher values go to left of chart]
			dvc.xScale2=d3.scale.linear()
				.domain([0,dvc.maxdvc])
				.range([(dvc.panelWidth/2)-dvc.cenGap,0])
				.nice();

			//create an ordinal scale for the y axis, based on y axis definitions in config file
			dvc.yScale=d3.scale.ordinal()
				.domain(dvc.settings.yDimension.index)
				.rangeBands([dvc.panelHeight,0],0);

		    //create svg for chart
		    var svg = d3.select('#graphic').append('svg')
		    			.attr("id","vizCanvas")
				        .attr("width", width)
				        .attr("height", height)

			//create basic svg groups in correct drawing order
			d3.select("#vizCanvas").append("g").attr("id","graphContent")
						.append("g")
						.attr("id","middleAxis");

			d3.select("#vizCanvas").append("g")
						.attr("id","intBars")
						.attr("fill-opacity",0.1)

			//function calls to create app UI and draw IntBars
			drawUI();
			drawIntBars();

			//now we have both datasets loaded, we can determine the max dvc value
			determineMax();

			//and finally we can draw chart 1 and 2 using the correct scaling information

			if(graphic.width() < dvc.threshold_sm) {
				drawChart(0);

				setTotals(0);
			} else {
				drawChart(0);
				drawChart(1);

				setTotals(0);
				setTotals(1);
			}




d3.selectAll('svg').attr('aria-hidden','true')

			//use pym to calculate chart dimensions
		    if (pymChild) {
		        pymChild.sendHeight();
		    }
		} //end drawGraphic

		function determineMax() {
			dvc.maxValues[0]=dvc.data[0].ons.concept.max[dvc.varDimension];
			dvc.maxValues[1]=dvc.data[1].ons.concept.max[dvc.varDimension];
			dvc.maxdvc=d3.max(dvc.maxValues);
		 } //end determineMax

		 function setTotals(chartNo)
		 {
			var myFormat=d3.format("0,000");
			var myTotal=myFormat(Math.round(((dvc.data[chartNo].ons.sums.series1[dvc.timeIndex])+(dvc.data[chartNo].ons.sums.series2[dvc.timeIndex]))/dvc.roundTo)*dvc.roundTo);
			var myTotalM=myFormat(Math.round((dvc.data[chartNo].ons.sums.series1[dvc.timeIndex])/dvc.roundTo)*dvc.roundTo);
			var myTotalF=myFormat(Math.round((dvc.data[chartNo].ons.sums.series2[dvc.timeIndex])/dvc.roundTo)*dvc.roundTo);

			var myFormatPer=d3.format(".3p");

			var myPerM=(dvc.data[chartNo].ons.sums.series1[dvc.timeIndex]/((dvc.data[chartNo].ons.sums.series1[dvc.timeIndex])+(dvc.data[chartNo].ons.sums.series2[dvc.timeIndex])));
			var myPerF=(dvc.data[chartNo].ons.sums.series2[dvc.timeIndex]/((dvc.data[chartNo].ons.sums.series1[dvc.timeIndex])+(dvc.data[chartNo].ons.sums.series2[dvc.timeIndex])));

			var myYear=dvc.data[chartNo].ons.time.index[dvc.timeIndex];
			//var myMales=myFormat(dvc.data[chartNo].ons.sums.series1[dvc.timeIndex]);
			//var myFemales=myFormat(dvc.data[chartNo].ons.sums.series2[dvc.timeIndex]);

			if(dvc.timeIndex==0 && dvc.nodata.indexOf(dvc.settings.config.vars[dvc.defaultSelections[chartNo]][1]) != -1){
				console.log("I'm here")
				$("#txtTotals"+chartNo).html("<span class='txtTotals'>No comparable data in "+ myYear +"<br/></span>");
			} else {
				$("#txtTotals"+chartNo).html("<span class='txtTotals'>"+myTotal+"</span> people in "+ myYear +"<br/>");
			}



			//$("#txtTotals"+chartNo).html("<span class='txtTotals'>"+myTotal+"</span> people in "+ myYear +"<br/>"/*<span class='txtTotals'>"+myMales+"</span> males<br/><span class='txtTotals'>"+myFemales+"</span> females<br/><span class='txtAdvice'>mouse or touch the graph to see more data</span>"*/);

			var svg = d3.select("MFbars"+chartNo);

			var dataArray=[ myPerM*200 , myPerF*200 ];

			d3.select("#MFbars"+chartNo).selectAll("rect")
					.data(dataArray)
					.enter()
					.append("rect")
					.attr("id", function(d,i){
								return "bar"+i+"_"+chartNo;
						})
					.attr("x",0)
					.attr("y",function(d,i){
						if(i==0) {
							return (i*50) +"%";
						} else {
							return ((i*50)+6) +"%";
						}
						})
					.attr("width", function(d){
								return d;
						})
					.attr("height","44%")
					.style("fill", dvc.chartColors[chartNo])
					.style("fill-opacity", 0.6)
					.style("stroke", dvc.chartColors[chartNo]);

			d3.select("#age"+chartNo).html("<span id='age'> </span>");

			var infoValues = d3.select("#infoValues"+chartNo)
			var infoPercent =d3.select("#infoPercent"+chartNo)

			if(dvc.timeIndex==0 && dvc.nodata.indexOf(dvc.settings.config.vars[dvc.defaultSelections[chartNo]][1]) != -1){

				infoValues.html("No male data available<span></span>"+"<br>No female data available")
				infoPercent.html("")
			} /*else  if (dvc.timeIndex==0 && dvc.scotland.indexOf(dvc.settings.config.vars[dvc.defaultSelections[chartNo]][1]) == -1 && dvc.ageover85.indexOf(age.substring(age.lastIndexOf("e ")+1, age.lastIndexOf("</")))){
				infoValues.html("No single year of age data available after age 84 ")
				infoPercent.html("")
			}*/ else {
				infoValues.html("<span id='infobold'>" + myTotalM +"</span> males<br><span id='infobold'>" + myTotalF +"</span> females")
				infoPercent.html(myFormatPer(myPerM) + "<br>" + myFormatPer(myPerF))
			}

			calcValues(0,dvc.selStart, dvc.selEnd);
			calcValues(1,dvc.selStart, dvc.selEnd);

			if(dvc.selStart!=null & dvc.selEnd!=null){
				$('#clearBtn').prop('disabled', false);

				var loopSt=Math.min(dvc.selStart,dvc.selEnd);
				var loopEnd=Math.max(dvc.selStart,dvc.selEnd);

				d3.select("#intBars").selectAll("rect").filter(function(d, i) {
						return i>=loopSt&&i<=loopEnd;
				})
				.attr("class","selected");

			} else {
				dvc.selMade=false;
			}


		if(chartNo == 0 ){
				pyram_area =d3.select("#sel0").select(".chosen-container").select(".chosen-single").select("span").property("innerHTML")
		}	else {
				pyram_area =d3.select("#sel1").select(".chosen-container").select(".chosen-single").select("span").property("innerHTML")
		}

			d3.select("#keyvaluehidden")
						.html("The total population of "+ pyram_area + " in " + myYear + " was " +
							myTotal + ". There were " +
								myTotalM + " males and " +
								myTotalF + " females.")

// console.log("The total population of "+ pyram_area + " in " + myYear + " was " +
// myTotal + ". There were " +
// 	myTotalM + " males and " +
// 	myTotalF + " females.")

		 } // end setTotals

		function redrawCharts() {
			 	if(graphic.width() < dvc.threshold_sm) {
					removeChart(0);
					drawChart(0);
					d3.select("#MFbars0").empty();
					setTotals(0);
					calcValues(0,dvc.selStart,dvc.selEnd)

					if(dvc.varDimension=="1"){
								d3.select("#xLabel0").select("text").text("Percentage of population in age band")
					} else {
								if(dvc.maxdvc>= 10000){
									d3.select("#xLabel0").select("text").text("Population in each age band")
								} else {
									d3.select("#xLabel0").select("text").text("Population (thousands) in each age band")
								}
					}




				} else {
					removeChart(0);
					removeChart(1);
					drawChart(0);
					drawChart(1);
					d3.select("#MFbars0").empty();
					d3.select("#MFbars1").empty();
					setTotals(0);
					setTotals(1);
					calcValues(0,dvc.selStart,dvc.selEnd)
					calcValues(1,dvc.selStart,dvc.selEnd)

					if(dvc.varDimension=="1"){
								d3.select("#xLabel0").select("text").text("Percentage of population in age band")
								d3.select("#xLabel1").select("text").text("Percentage of population in age band")
					} else {
							if(dvc.maxdvc>= 10000){
								d3.select("#xLabel0").select("text").text("population (thousands) in each age band")
								d3.select("#xLabel1").select("text").text("population (thousands) in each age band")
							} else {
								d3.select("#xLabel0").select("text").text("population in each age band")
								d3.select("#xLabel2").select("text").text("population in each age band")
							}
					}
				}
				updateHash();
		} //end redrawCharts

		function loadData(file,chartNo)
		 {

			d3.json(file, function(json)	{
				dvc.data[chartNo]=json;
				determineMax();
				redrawCharts();
				updateHash();
			});
		 } //end loadData

		 function drawIntBars()
		 {
			 //create the interaction layer - bars that straddle the full width of the visualisation
			 d3.select("#intBars")
				.selectAll("rect")
				.data(dvc.settings.yDimension.index)
				.enter()
				.append("rect")
				.attr("id",function(d,i)
					{
						return "intbar"+d[0];
					})
				.attr("y",function(d,i)	{
						return margin_top+dvc.yScale(i);
					})
				.attr("width",function()	{
					if(graphic.width() < dvc.threshold_sm){
						return dvc.panelWidth/*-dvc.xAdjust*2*/;
					} else {
						return (dvc.panelWidth*2)+dvc.panelGap+margin_left*2-dvc.xAdjust*2;
					}

				})
				.attr("height",dvc.yScale.rangeBand())
				.attr("x",function(){if(graphic.width() < dvc.threshold_sm){
								return margin_left;
							} else {
								return margin_left+dvc.xAdjust;
							}
				})
				.attr("class","unselected")
				.attr("data-nm",function(d,i)	{
					return (i);
				});

		 		if (Modernizr.touch){

					dvc.touchTimer;//measures for a long touch
					dvc.touchSel;//actively touched bar
					d3.select("#intBars")
					.attr("ontouchstart","tellMe(evt)")
					.attr("ontouchmove","tellMe(evt)")
					.attr("ontouchend","tellMe(evt)");
				} else {

					d3.select("#intBars")
					.attr("onmouseover","tellMe(evt)")
					.attr("onmouseout","tellMe(evt)")
					.attr("onmousedown","tellMe(evt)")
					.attr("onmouseup","tellMe(evt)");
				}
		 } //end drawIntBars

		 function removeChart(chartIndex) {

			chartTarget=document.getElementById("graph"+chartIndex);
			hostLayer=chartTarget.parentNode;
			hostLayer.removeChild(chartTarget);
		 } // end removeChart


		 function drawChart(chartIndex) {

			//main graph group
			d3.select("#graphContent").append("g")
				.attr("id","graph"+chartIndex)

			d3.select("#graph"+chartIndex).append("g")
				.attr("id","chartAxis"+chartIndex);

			d3.select("#graph"+chartIndex).append("g").attr("id","aniContainer"+chartIndex).attr("transform","translate(0,0)");

			d3.select("#graph"+chartIndex).append("g")
							.attr("id", "xLabel"+chartIndex)
							.append("text")
							.attr("x",dvc.panelWidth/2)
							.attr("y",dvc.panelHeight+(margin_bottom*0.5))
							.attr("text-anchor", "middle")
							.text(function(d){
								if(dvc.varDimension=="0"){
										if(dvc.maxdvc>= 10000){
											return "Population (thousands) in each age band";
										} else {
											return "Population in each age band";
										}
									} else {
										return "Percentage of population in age band";
									}
								});

			d3.select("#graph"+chartIndex).append("g")
							.attr("id", "yLabel"+chartIndex)
							.append("text")
							.attr("x",dvc.panelWidth/2)
							.attr("y",-margin_top/2)
							.attr("text-anchor", "middle")
							.text("Age");

			d3.select("#graph"+chartIndex).append("g")
							.attr("id", "maleLabel"+chartIndex)
							.append("text")
							.attr("x",margin_left)
							.attr("y",margin_top)
							.attr("text-anchor", "start")
							.text("Male");

			d3.select("#graph"+chartIndex).append("g")
							.attr("id", "femaleLabel"+chartIndex)
							.append("text")
							.attr("x",dvc.panelWidth-margin_left)
							.attr("y",margin_top)
							.attr("text-anchor", "end")
							.text("Female");

			d3.select("#graph"+chartIndex).append("g")
							.attr("id", "outlinesText"+chartIndex)
							.append("text")
							.attr("x",dvc.panelWidth/2)
							.attr("y",dvc.panelHeight+(margin_bottom*0.75))
							.attr("text-anchor", "middle")
							.text("")

			//frontPanel
			d3.select("#graph"+chartIndex)
				.append("rect")
				.attr("class","panelFront")
				.attr("pointer-events","none")
				.attr("id","panel"+chartIndex)
				.attr("opacity",0)
				.attr("x",0)
				.attr("y",-25)
				.attr("width",dvc.panelWidth+margin_left)
				.attr("height",dvc.panelHeight+70);

			var chartData;

			if(graphic.width() < dvc.threshold_sm){
						d3.select("#graph0").attr("transform","translate("+margin_left+","+margin_top+")");
						chartData=dvc.data[0];
						dvc.maxValues[0]=dvc.data[0].ons.concept.max[dvc.varDimension];

			} else {
					//offset according to chart number
					if (chartIndex==0)
					{
						d3.select("#graph0").attr("transform","translate("+(margin_left+dvc.xAdjust)+","+margin_top+")");
						chartData=dvc.data[0];
						dvc.maxValues[0]=dvc.data[0].ons.concept.max[dvc.varDimension];
					}	else
					{
						d3.select("#graph1").attr("transform","translate("+(margin_left*3+dvc.panelWidth+dvc.panelGap-dvc.xAdjust)+","+margin_top+")");
						chartData=dvc.data[1];
						dvc.maxValues[1]=dvc.data[1].ons.concept.max[dvc.varDimension];
					}
			}


			//console.log(chartData);

			//create first simple scale
			dvc.xScale=d3.scale.linear()
				.domain([0,dvc.maxdvc])
				.range([0,(dvc.panelWidth/2)-dvc.cenGap])
				.nice();

			//a scale object to define the inverted axis of the left hand side of pyramid [higher values go to left of chart]
			dvc.xScale2=d3.scale.linear()
				.domain([0,dvc.maxdvc])
				.range([(dvc.panelWidth/2)-dvc.cenGap,0])
				.nice();



			if(dvc.lockOutlines==false){
			 			dvc.outlineIndex= dvc.timeIndex;
			} else {
						dvc.outlineIndex = dvc.data[0].ons.time.index.indexOf(dvc.LockedYear);

						//need to update text element to say outlines are locked for a particular year
						d3.select("#outlinesText0").select("text").text("outline shows year "+dvc.data[0].ons.time.index[dvc.outlineIndex])
						d3.select("#outlinesText1").select("text").text("outline shows year "+dvc.data[0].ons.time.index[dvc.outlineIndex])


						d3.select("#lockBtn").select("text").text(" unlock outlines")

			}



			//get to the first data value for series 1 and 2, needed for beginning outline drawing
			var value1=chartData.ons.value[0][0][dvc.outlineIndex][dvc.varDimension];
			var value2=chartData.ons.value[1][0][dvc.outlineIndex][dvc.varDimension];

			//starting points for outlines to the histograms
			var pathData1="M "+((dvc.panelWidth/2)-dvc.cenGap)+" "+dvc.panelHeight+" L"+dvc.xScale2(value1)+" "+dvc.panelHeight+" ";
			var pathData2="M "+((dvc.panelWidth/2)+dvc.cenGap)+" "+dvc.panelHeight+" L"+((dvc.panelWidth/2)+dvc.cenGap+dvc.xScale(value2))+" "+dvc.panelHeight+" ";


			//draw first series - typically male - create a group, create rectangles and update path data for outlines
		//	console.log(chartData.ons.value[0]);

				d3.select("#aniContainer"+chartIndex).append("g")
					.attr("id","seriesA"+chartIndex)
					.selectAll("rect")
					.data(chartData.ons.value[0])
					.enter()
					.append("rect")
					.attr("class",function(d,i){
							return "Mbar"+i;
					})
					.attr("fill",dvc.chartColors[chartIndex])
					.attr("fill-opacity",0.5)
					.attr("width",function(d)	{
						return (dvc.panelWidth/2-dvc.cenGap)-dvc.xScale2(d[dvc.timeIndex][dvc.varDimension]);
					})
					.attr("height",dvc.yScale.rangeBand())
					.attr("y",function(d,i)	{


						if(dvc.outlineIndex=='na'){
						//while we are in a loop to calculate the y, we can also continue to draw the outline path data
						pathData1=pathData1+"L "+(dvc.xScale2(d[dvc.timeIndex][dvc.varDimension]))+" "+dvc.yScale(i-1)+" L "+dvc.xScale2(d[dvc.timeIndex][dvc.varDimension])+" "+dvc.yScale(i);
						return dvc.yScale(i);
						} else {
						pathData1=pathData1+"L "+(dvc.xScale2(d[dvc.outlineIndex][dvc.varDimension]))+" "+dvc.yScale(i-1)+" L "+dvc.xScale2(d[dvc.outlineIndex][dvc.varDimension])+" "+dvc.yScale(i);
						return dvc.yScale(i);
						}


					})
					.attr("x", function(d)	{
						return dvc.xScale2(d[dvc.timeIndex][dvc.varDimension]);
					});

		//	console.log(chartData.ons.value[1]);
				//draw second series - typically female
				d3.select("#aniContainer"+chartIndex).append("g")
					.attr("id","seriesB"+chartIndex)
					.selectAll("rect")
					.data(chartData.ons.value[1])
					.enter()
					.append("rect")
					.attr("class",function(d,i){
							return "Fbar"+i;
					})
					.attr("fill",dvc.chartColors[chartIndex])
					.attr("fill-opacity",0.5)
					.attr("width",function(d)	{
						return dvc.xScale(d[dvc.timeIndex][dvc.varDimension]);
					})
					.attr("height",dvc.yScale.rangeBand())
					.attr("y",function(d,i)	{
						if(dvc.outlineIndex=='na'){
						//while we are in a loop to calculate the y, we can also continue to draw the outline path data
						pathData2=pathData2+"L "+((dvc.panelWidth/2)+dvc.cenGap+dvc.xScale(d[dvc.timeIndex][dvc.varDimension]))+" "+dvc.yScale(i-1)+" L "+((dvc.panelWidth/2)+dvc.cenGap+dvc.xScale(d[dvc.timeIndex][dvc.varDimension]))+" "+dvc.yScale(i);
						return dvc.yScale(i);
						} else {
						pathData2=pathData2+"L "+((dvc.panelWidth/2)+dvc.cenGap+dvc.xScale(d[dvc.outlineIndex][dvc.varDimension]))+" "+dvc.yScale(i-1)+" L "+((dvc.panelWidth/2)+dvc.cenGap+dvc.xScale(d[dvc.outlineIndex][dvc.varDimension]))+" "+dvc.yScale(i);
						return dvc.yScale(i);
						}
					})
					.attr("x", function(d)	{
						return (dvc.panelWidth/2)+dvc.cenGap;
					});

				//finish the path data for series 1 and 2
				pathData1=pathData1+"L "+((dvc.panelWidth/2)-dvc.cenGap)+" 0";//need to teak the 0 on the y here to use the yscale
				pathData2=pathData2+"L "+((dvc.panelWidth/2)+dvc.cenGap)+" 0";

				d3.select("#aniContainer"+chartIndex)
				.append("g")
					.attr("id","outlines"+chartIndex)
					.attr("transform", "translate(0,0)")
					.append("path")
						.attr("stroke",dvc.chartColors[chartIndex])
						.attr("id","outlineA"+chartIndex)
						.attr("fill","none")
						.attr("stroke-width","2px")
						.attr("d",pathData1);

				d3.select("#outlines"+chartIndex)
				.append("path")
					.attr("stroke",dvc.chartColors[chartIndex])
					.attr("id","outlineB"+chartIndex)
					.attr("fill","none")
					.attr("stroke-width","2px")
					.attr("d",pathData2);

				if(graphic.width() >= dvc.threshold_sm){
					if (dvc.overlap==true)
						{
							//move graph1
							d3.select("#graph0")
							.transition()
							.delay(500)
							.duration(500)
							.attr("transform","translate("+-(0)+","+margin_top+")");

							//move graph2
							d3.select("#graph1")
							.transition()
							.delay(500)
							.duration(500)
							.attr("transform","translate("+((margin_left*4)+dvc.panelWidth+dvc.panelGap)+","+margin_top+")");

							//move outline1
							d3.select("#outlines0")
							.transition()
							.delay(500)
							.duration(500)
							.attr("transform","translate("+(((dvc.xAdjust+dvc.panelWidth+dvc.panelGap)/2)+margin_left*0.75)+",0)");

							//move outline2
							d3.select("#outlines1")
							.transition()
							.delay(500)
							.duration(500)
							.attr("transform","translate(-"+(((dvc.xAdjust+dvc.panelWidth+dvc.panelGap)/2)+margin_left*0.75)+",0)");

							//dampen down main graphs
							d3.select("#panel0")
							.transition()
							.duration(100)
							.attr("opacity",0.7);

							d3.select("#panel1")
							.transition()
							.duration(100)
							.attr("opacity",0.7);

							d3.select("#intBars")
								.selectAll("rect")
								.attr("width",dvc.panelWidth)
								.attr("x", margin_left+(dvc.panelWidth+dvc.panelGap+dvc.xAdjust)/2)

						}
				} else {

				}
				//draw and append the x axes
				//left hand axis - the inverted one - note it calls xScale2
				var xAxis1=d3.svg.axis()
					.scale(dvc.xScale2)
					.orient("bottom")
					.ticks(3)
					.tickFormat(function(d){
								if(dvc.varDimension=="0"){
									if(dvc.maxdvc>= 10000){
										//var formatSIunits = d3.format("s");
										return d/1000;
									} else {
										return d
									}
								} else {
									return d;
								}
						});

				d3.select("#chartAxis"+chartIndex).append("g")
				.attr("class","axis")
				.attr("id", "leftXaxis"+chartIndex)
				.attr("transform","translate(0,"+dvc.panelHeight+")")
				.call(xAxis1);

				//right hand axis
				var xAxis2=d3.svg.axis()
					.scale(dvc.xScale)
					.orient("bottom")
					.ticks(3)
					.tickFormat(function(d){
								if(dvc.varDimension=="0"){
									if(dvc.maxdvc>= 10000){
										//var formatSIunits = d3.format("s");
										return d/1000;
									} else {
										return d
									}
								} else {
									return d;
								}
						});

				d3.select("#chartAxis"+chartIndex).append("g")
				.attr("class","axis")
				.attr("id", "rightXaxis"+chartIndex)
				.attr("transform","translate("+(dvc.cenGap+(dvc.panelWidth/2))+","+dvc.panelHeight+")")
				.call(xAxis2);


				var xAxisMid1=d3.svg.axis()
					.scale(dvc.xScale2)
					.orient("bottom")
					.ticks(2);

				var xAxisMid2=d3.svg.axis()
					.scale(dvc.xScale)
					.orient("bottom")
					.ticks(2);

				//draw the y axis ticks
				d3.select("#chartAxis"+chartIndex).append("g").attr("class","axis")
				.selectAll("path")
				.data(dvc.settings.yDimension.yLabels)
				.enter()
				.append("path")
				.attr("d", function(d)	{
					//while we're inside a pseudo-loop, can create the text labels too
					d3.select("#chartAxis"+chartIndex)
							.append("text")
							.attr("y",dvc.yScale(d[0]))
							.attr("x",dvc.panelWidth/2)
							.attr("text-anchor","middle")
							.attr("dy",4)
							.text(d[1]);
					return "M 0,"+dvc.yScale(d[0])+" L"+((dvc.panelWidth/2)-dvc.cenGap+3)+","+dvc.yScale(d[0])+" M "+((dvc.panelWidth/2)+dvc.cenGap-3)+","+dvc.yScale(d[0])+" L"+dvc.panelWidth+","+dvc.yScale(d[0]);
				});

		 } //end drawChart


		 //this function redraws the chart using a new timeIndex value - same data and concept value
		 function modifyChart(chartNo)
		 {
		 	//console.log("i'm going to modify chart no "+chartNo+");

			 //get to the first data value for series 1 and 2, needed for beginning outline drawing
			var value1=dvc.data[chartNo].ons.value[0][0][dvc.timeIndex][dvc.varDimension];
			var value2=dvc.data[chartNo].ons.value[1][0][dvc.timeIndex][dvc.varDimension];
			 var pathData1="M "+((dvc.panelWidth/2)-dvc.cenGap)+" "+dvc.panelHeight+" L"+dvc.xScale2(value1)+" "+dvc.panelHeight+" ";
			 var pathData2="M "+((dvc.panelWidth/2)+dvc.cenGap)+" "+dvc.panelHeight+" L"+((dvc.panelWidth/2)+dvc.cenGap+dvc.xScale(value2))+" "+dvc.panelHeight+" ";

			//dvc.m2=performance.now()


			//select 1st series of bars
			var myBars= d3.select("#seriesA"+chartNo).selectAll("rect")
			.transition()
			.duration(500)
			.attr("width", function(d,i)	{
				pathData1=pathData1+"L "+(dvc.xScale2(d[dvc.timeIndex][dvc.varDimension]))+" "+dvc.yScale(i-1)+" L "+dvc.xScale2(d[dvc.timeIndex][dvc.varDimension])+" "+dvc.yScale(i);
				return (dvc.panelWidth/2-dvc.cenGap)-dvc.xScale2(d[dvc.timeIndex][dvc.varDimension]);
			})
			.attr("x", function (d)	{

				return dvc.xScale2(d[dvc.timeIndex][dvc.varDimension]);
			});

			//dvc.m3=performance.now()
						//	console.log("modify chart time3 "+(dvc.m3 -dvc.m2));

			//second set of bars
			var myBars= d3.select("#seriesB"+chartNo).selectAll("rect")
			.transition()
			.duration(500)
			.attr("width", function(d,i)	{
				pathData2=pathData2+"L "+((dvc.panelWidth/2)+dvc.cenGap+dvc.xScale(d[dvc.timeIndex][dvc.varDimension]))+" "+dvc.yScale(i-1)+" L "+((dvc.panelWidth/2)+dvc.cenGap+dvc.xScale(d[dvc.timeIndex][dvc.varDimension]))+" "+dvc.yScale(i);
				return dvc.xScale(d[dvc.timeIndex][dvc.varDimension]);
			})
			.attr("x", function (d)	{
					return (dvc.panelWidth/2)+dvc.cenGap;
			});



			//finish the path data for series 1 and 2
			pathData1=pathData1+"L "+((dvc.panelWidth/2)-dvc.cenGap)+" 0";
			pathData2=pathData2+"L "+((dvc.panelWidth/2)+dvc.cenGap)+" 0";

			 if (dvc.lockOutlines)	{
				//do thing to the outlines, they are locked

			 }	else
			 {
				//move the outlines too.
				d3.select("#outlineA"+chartNo)
				.transition()
				.duration(500)
				.attr("d",pathData1);

				//move the outlines too.
				d3.select("#outlineB"+chartNo)
				.transition()
				.duration(500)
				.attr("d",pathData2);

			 }

			setTotals(chartNo);
			//update buttons if required
			if(dvc.bAnimate==true){
				$('#forwardStepBtn').prop('disabled', true);
				$('#backStepBtn').prop('disabled', true);
			} else if (dvc.timeIndex==0){
				$('#forwardStepBtn').prop('disabled', false);
				$('#backStepBtn').prop('disabled', true);
			} else if (dvc.timeIndex==dvc.timeLength-1){
				$('#forwardStepBtn').prop('disabled', true);
				$('#backStepBtn').prop('disabled', false);
			} else {
				$('#forwardStepBtn').prop('disabled', false);
				$('#backStepBtn').prop('disabled', false);
			}

			updateHash();


		 } // end modifyChart

		 function drawUI()
		 {

			 //if there's more than one variable, create a selection list to allow user to change variable
			 if (dvc.settings.config.vars.length>2)
			 {
			var dropdown0 = d3.select("#dropdown0")

			dropdown0.append("div").text("Choose an area")

			var optns0 =dropdown0.append("div").attr("id","sel0")
					.append("select").attr("id","areaselect0")
					.attr("class","chosen-select");


				optns0.selectAll("p").data(dvc.settings.config.vars).enter().append("option")
					.attr("value", function(d){ return d[0]}) /* Optional */
					.attr("id", function(d,i){ return "opt0_"+i}) /* Optional */
					.attr("data-index", function(d,i){ return i})
					.text(function(d){ return d[1]});

			var dropdown1 = d3.select("#dropdown1")

			dropdown1.append("div").text("Choose an area")

			var optns1 =dropdown1.append("div").attr("id","sel1")
					.append("select").attr("id","areaselect1")
					.attr("class","chosen-select");

				optns1.selectAll("p").data(dvc.settings.config.vars).enter().append("option")
					.attr("value", function(d){ return d[0]}) /* Optional */
					.attr("id", function(d,i){ return "opt1_"+i}) /* Optional */
					.attr("data-index", function(d,i){ return i})
					.text(function(d){ return d[1]});

				$('#areaselect0').chosen({width: "100%",allow_single_deselect: false}).on('change',function(d){
						loadData("data/"+this.value,0);
						 var area0 =this.value;
						 dvc.defaultSelections[0] = document.getElementById('areaselect0').selectedIndex


						 selection_dropdown ="Pyramid 1: "+d3.select("#sel0").select(".chosen-container").select(".chosen-single").select("span").property("innerHTML")
						 dataLayer.push({
							'event': 'pyramidDropSelect',
							'selected': selection_dropdown
						})

				})

				$('#areaselect1').chosen({width: "100%",allow_single_deselect: false}).on('change',function(d){
						loadData("data/"+this.value,1);
						var area1 =this.value;
						dvc.defaultSelections[1] = document.getElementById('areaselect1').selectedIndex
						//console.log (dvc.defaultSelections);
						selection_dropdown = "Pyramid 2: "+d3.select("#sel1").select(".chosen-container").select(".chosen-single").select("span").property("innerHTML")

						dataLayer.push({
							'event': 'pyramidDropSelect',
							'selected': selection_dropdown
						})
				})

				d3.select('#areaselect0_chosen').select('abbr').on('keypress',function(evt){
					if(d3.event.keyCode==13 || d3.event.keyCode==32){
						d3.event.preventDefault();
						$("#areaselect0").val("").trigger('chosen:updated');
					}
				})

				d3.select('#areaselect0_chosen1').select('abbr').on('keypress',function(evt){
					if(d3.event.keyCode==13 || d3.event.keyCode==32){
						d3.event.preventDefault();
						$("#areaselect1").val("").trigger('chosen:updated');
					}
				})

			//	d3.select("#sel0").attr("tabindex", 0);
			//	d3.select("#sel1").attr("tabindex", 0);

			}


			d3.select("#areaselect0_chosen").select("input.chosen-search-input").attr("id", "chosensearchinput1")
			d3.select("#areaselect1_chosen").select("input.chosen-search-input").attr("id", "chosensearchinput2")

			 d3.select("#areaselect0_chosen").select("div.chosen-search")
			 	.insert("label","input.chosen-search-input")
	 			.attr("class", "visuallyhidden")
				.attr("for", "chosensearchinput1")
				.html("Type to select first comparison area")

				d3.select("#areaselect1_chosen").select("div.chosen-search")
 			 	.insert("label","input.chosen-search-input")
 	 			.attr("class", "visuallyhidden")
 				.attr("for", "chosensearchinput2")
 				.html("Type to select second comparison area")

		//	d3.select("#areaselect1_chosen").select(".chosen-search").insert("label","input.chosen-search-input2").attr("class", "visuallyhidden").attr("for". "chosen-search-input2").html("Type to select 2nd comaprison area")

			function updateUI(chartNo, area){
				var name = '#opt'+chartNo+'_'+dvc.defaultSelections[chartNo];
				var newVal = d3.select(name).attr('value')
				 $('#areaselect'+chartNo).val(newVal);
				 $('#areaselect'+chartNo).trigger("chosen:updated");
			}
			//alert(dvc.defaultSelections);
			updateUI(0,dvc.defaultSelections[0]);
			updateUI(1,dvc.defaultSelections[1]);




			 //compare functionality



				//$("#dimension"+dvc.varDimension).attr("checked","checked");
				//$("#conceptRadio").buttonset("refresh");

				// d3.select("#dimension0").attr("tabindex", 8);
				// d3.select("#dimension1").attr("tabindex", 9);


				// $( "#conceptRadio" ).buttonset().change(function() {
				// 	//identify selected dimenion
				// 	dvc.varDimension=parseFloat($("#conceptRadio :radio:checked").attr('id').split("dimension")[1]);
				// 	//console.log(dvc.varDimension)
				// 	determineMax();
				// 	redrawCharts();
				// })


				$("#controls1").empty();


			 //if there is a time series, configure a time slider and a lock outlines button
			 if (dvc.timeLength>1)
			 {
				var group = d3.select("#controls1")
						.append("div")
						.attr("id", "btns")
						.attr("class", "col-sm-7 col-xs-12 btn-group")
						.attr("role", "group")
						.attr("aria-label", "Pyramid controls to change time period");

				span1 = group.append("button")
						.attr("type","button")
						.attr("class", "btn btn-group__btn btn--primary btn--previous")
						.attr("id", "backStepBtn")
						.attr("aria-label", "Step back one period in time");

//				span1.append("span")
//						.attr("class","glyphicon glyphicon-step-backward");
				span1.append("text").text(" back a decade");

				span2 = group.append("button")
						.attr("type","button")
						.attr("class", "btn btn-group__btn btn--primary btn--play")
						.attr("id", "playPauseBtn")
						.attr("aria-label", "Click to play or pause animation");;

//				span2.append("span")
//						.attr("class","glyphicon glyphicon-play");
				span2.append("text").text(" play");

				span3 = group.append("button")
						.attr("type","button")
						.attr("class", "btn btn-group__btn btn--primary btn--next")
						.attr("id", "forwardStepBtn")
						.attr("aria-label", "Step forward one period in time");




//				span3.append("span")
//						.attr("class","glyphicon glyphicon-step-forward");
				span3.append("text").text(" forward a decade");

			//update buttons if required
			if(dvc.bAnimate==true){
				$('#forwardStepBtn').prop('disabled', true);
				$('#backStepBtn').prop('disabled', true);
				//replace button text n icon
					d3.select("#playPauseBtn").attr("class","btn btn-group__btn btn--primary btn--pause");

					d3.select("#playPauseBtn").select("text")
						.text(" pause");
			} else if (dvc.timeIndex<=0){
				$('#forwardStepBtn').prop('disabled', false);
				$('#backStepBtn').prop('disabled', true);
			} else if (dvc.timeIndex==dvc.timeLength-1){
				$('#forwardStepBtn').prop('disabled', true);
				$('#backStepBtn').prop('disabled', false);
			} else {
				$('#forwardStepBtn').prop('disabled', false);
				$('#backStepBtn').prop('disabled', false);
			}

			$("#backStepBtn").click(backStepBtn);
			$("#forwardStepBtn").click(forwardStepBtn);


				 d3.select("#controls1").append('div').attr("class"," col-sm-4 hidden-xs").append('div').attr("id","sliderDiv").append('div').attr("id","timeSlider");
				$('#timeSlider').labeledslider({
						min:0,
						max: dvc.timeLength-1,
                                tickInterval:1,
		//				tickArray: [0,5,10,15,20,25],

//dvc.settings.config.sliderValues,

						tickLabels: {
								0: "1998",
								1: "2008",
								2: "2018",
								3: "2028",
								4: "2038"
						},
	//					value: dvc.timeIndex,

						slide:function(event, ui){

							 dvc.timeIndex =ui.value;

							 d3.select(".ui-slider-handle").attr("aria-valuenow", dvc.settings.config.years[dvc.timeIndex])

							//	testFunction();
							 	modifyChart(0);
							 	modifyChart(1);


							calcValues(0,dvc.selStart,dvc.selEnd)
							calcValues(1,dvc.selStart,dvc.selEnd)

							dataLayer.push({
								'event': 'pyramidSlider',
								'selected': 'change year slider'
							})

						}
				})
				$('#timeSlider').labeledslider( 'option', 'value', dvc.timeIndex);


				d3.select(".ui-slider-handle").attr('role', 'slider')
							.attr("aria-valuemin", dvc.timeMin)
							.attr("aria-valuenow", dvc.settings.config.years[dvc.timeIndex])
							.attr("aria-valuemax", dvc.timeMax)

			}//end if









			 //radio button to switch between count and % - if they exist!
			 if (dvc.settings.config.varConcept.length>1)
			 {

				d3.select("#note").remove();
				d3.select(".allContent").append("div")
			 	.attr("id","note")
				.attr("class", "row")
//				.append("text")
//				.text("Note: figures have been rounded to the nearest 100 people therefore totals may not add exactly.");

				var url = decodeURI(window.location.hash);
				params = url.split("/");

				if (url == ""){
					dvc.varDimension=dvc.settings.config.defaultConcept
				} else {
					dvc.varDimension=params[8];
				}

				$(function() {
					$('#outlinesToggle').bootstrapToggle({
						on: 'Outlines locked',
						off: 'Outlines unlocked',
						width: "170px",
						size: "mini",
						onstyle: "-secondary",
						offstyle: "-secondary"
				   });
					$('#outlinesToggle').change(lockOutlines)
				})

$( "#outlinesToggle" ).parent().attr( "id", "outlinesButton" ).attr('tabindex',0).attr("role","switch").attr("aria-checked", false)


		d3.select("#outlinesButton").on("keypress",function(evt){
			if(d3.event.keyCode==32||d3.event.keyCode==13){
				document.getElementById("outlinesToggle").click()

				if(dvc.lockOutlines==true){
					d3.select("#outlinesButton").classed("off",false).attr("aria-checked", true)
				} else {
					d3.select("#outlinesButton").classed("off",true).attr("aria-checked", false)
				}
			}
		});

				$(function() {
					$('#overlapToggle').bootstrapToggle({
						on: 'Overlap on',
						off: 'Overlap off',
						width: "150px",
						size: "mini",
						onstyle: "-secondary",
						offstyle: "-secondary"
				   });
					$('#overlapToggle').change(overlap)
				})

				//get parent of overlap checbox and give id so can hide in mobile view

				$( "#overlapToggle" ).parent().attr( "id", "overlapButton" ).attr('tabindex',0).attr("role","switch").attr("aria-checked", false);

				d3.select("#overlapButton").on("keypress",function(evt){
					if(d3.event.keyCode==32||d3.event.keyCode==13){
						document.getElementById("overlapToggle").click()

						if(dvc.overlap==true){
							d3.select("#overlapButton").classed("off",false).attr("aria-checked", true)
						} else {
							d3.select("#overlapButton").classed("off",true).attr("aria-checked", false)
						}
					}
				});


				if(graphic.width() < dvc.threshold_sm){
						$("#overlapButton").hide();
						dvc.overlap=false
				} else {
						$("#overlapButton").show();
				}
				updateHash();


				$(function() {
					$('#dimensionsToggle').bootstrapToggle({
						on: '%',
						off: 'number',
						width: "110px",
						size: "mini",
						onstyle: "-secondary",
						offstyle: "-secondary"
				   	});
					$('#dimensionsToggle').bootstrapToggle('on')

					$('#dimensionsToggle').change(dimensions)

				})

				$( "#dimensionsToggle" ).parent().attr( "id", "dimensionsButton" ).attr('tabindex',0).attr("role","switch").attr("aria-checked", false);

				d3.select("#dimensionsButton").select(".toggle-group").select(".toggle-on").append("span").attr("class", "visuallyhidden").text(" or ")

				d3.select("#dimensionsButton").on("keypress",function(evt){
					if(d3.event.keyCode==32||d3.event.keyCode==13){
						document.getElementById("dimensionsToggle").click()


						if(dvc.varDimension=="0"){
							d3.select("#dimensionsButton").classed("off",true).attr("aria-checked", false)
						} else {
							d3.select("#dimensionsButton").classed("off",false).attr("aria-checked", true)
						}
					}
				});


				$( "#clearBtn" ).click(clearSel);
				$( "#clearBtn" ).prop('disabled', true);



				//add event listener for animating
				$("#playPauseBtn").click(playPause);

			 }//end if time series


		 }//end drawUI function


		function playPause (){
					if (dvc.bAnimate==true) {
						dataLayer.push({
							'event': 'playButton',
							'selected': 'paused'
						})


							dvc.bAnimate=false;
							d3.select("#playPauseBtn").attr("class","btn btn-group__btn btn--primary btn--play");
							d3.select("#playPauseBtn")
								.select("text")
								.text(" play")

					$('#backStepBtn').prop('disabled', false);
					$('#forwardStepBtn').prop('disabled', false);

							clearInterval(dvc.theInterval);

					 } else if (dvc.bAnimate==false) {
							dataLayer.push({
								'event': 'playButton',
								'selected': 'playing'
							})
					 		//start animation

								if (dvc.timeIndex==dvc.timeLength-1){
									//alert("yes")
										dvc.timeIndex=0;
										modifyChart(0);
										modifyChart(1);
										calcValues(0,dvc.selStart,dvc.selEnd)
										calcValues(1,dvc.selStart,dvc.selEnd)
						$('#timeSlider').labeledslider( 'option', 'value', dvc.timeIndex);
						d3.select(".ui-slider-handle").attr("aria-valuenow", dvc.settings.config.years[dvc.timeIndex])

								}
							dvc.bAnimate=true;
							d3.select("#playPauseBtn").attr("class","btn btn-group__btn btn--primary btn--pause");
							d3.select("#playPauseBtn")
								.select("text")
								.text("pause")


					$('#backStepBtn').prop('disabled', true);
					$('#forwardStepBtn').prop('disabled', true);


							dvc.theInterval=setInterval("updateAni()",1000);
							//alert("up to here")
					}
		}

		function backStepBtn(){
				//$('#forwardStepBtn').prop('disabled', false);
				dataLayer.push({
					'event': 'pyramidSlider',
					'selected': 'change year btn'
				})
				//if (dvc.timeIndex>0)	{
								dvc.timeIndex--;
								modifyChart(0);
								modifyChart(1);
								calcValues(0,dvc.selStart,dvc.selEnd)
								calcValues(1,dvc.selStart,dvc.selEnd)
						$('#timeSlider').labeledslider( 'option', 'value', dvc.timeIndex);
						d3.select(".ui-slider-handle").attr("aria-valuenow", dvc.settings.config.years[dvc.timeIndex])


								//updateChart();
				//			} else {
//								$('#backStepBtn').prop('disabled', true);
//							}
		}

		function forwardStepBtn(){
				//$('#backStepBtn').prop('disabled', false);
				dataLayer.push({
					'event': 'pyramidSlider',
					'selected': 'change year btn'
				})
				//if (dvc.timeIndex<dvc.timeLength-1)	{
								dvc.timeIndex++;
								modifyChart(0);
								modifyChart(1);
								calcValues(0,dvc.selStart,dvc.selEnd)
								calcValues(1,dvc.selStart,dvc.selEnd)
						$('#timeSlider').labeledslider( 'option', 'value', dvc.timeIndex);
						d3.select(".ui-slider-handle").attr("aria-valuenow", dvc.settings.config.years[dvc.timeIndex])
								//updateChart();
				//			} else {
				//				$('#forwardStepBtn').prop('disabled', true);
				//			}
		}

		 function updateAni()
		{	//alert("updateani")
			if (dvc.timeIndex<dvc.timeLength-1){
				dvc.timeIndex++
			} else {
				if (dvc.bLoop){
					dvc.timeIndex=0;
				} else {
					dvc.bAnimate=false;
					clearInterval(dvc.theInterval);
				}
			}
			//updateValues();
			modifyChart(0);
			modifyChart(1);
			calcValues(0,dvc.selStart,dvc.selEnd)
			calcValues(1,dvc.selStart,dvc.selEnd)
			$('#timeSlider').labeledslider( 'option', 'value', dvc.timeIndex);
			d3.select(".ui-slider-handle").attr("aria-valuenow", dvc.settings.config.years[dvc.timeIndex])

		}

			function overlap()	{


						if (dvc.overlap==true){
							dvc.overlap=false;
							d3.select("#overlapButton").attr("aria-checked", false)
							//move graph1
							d3.select("#graph0")
							.transition()
							.delay(500)
							.duration(500)
							.attr("transform","translate("+(margin_left+dvc.xAdjust)+","+margin_top+")");

							//move graph2
							d3.select("#graph1")
							.transition()
							.delay(500)
							.duration(500)
							.attr("transform","translate("+((margin_left*3)+dvc.panelWidth+dvc.panelGap-dvc.xAdjust)+","+margin_top+")");

							//move outline1
							d3.select("#outlines0")
							.transition()
							.delay(500)
							.duration(500)
							.attr("transform","translate(0,0)");

							//move outline2
							d3.select("#outlines1")
							.transition()
							.delay(500)
							.duration(500)
							.attr("transform","translate(0,0)");

							d3.select("#intBars")
								.selectAll("rect")
								.attr("width",(dvc.panelWidth*2)+dvc.panelGap+(margin_left+margin_right)-dvc.xAdjust*2)
								.attr("x", margin_left+dvc.xAdjust)

							//restore  main graphs
							d3.select("#panel0")
							.transition()
							.duration(100)
							.attr("opacity",0);

							d3.select("#panel1")
							.transition()
							.duration(100)
							.attr("opacity",0);
						} else {
							dvc.overlap=true;
							d3.select("#overlapButton").attr("aria-checked", true)
							dataLayer.push({
								"event": "pyramidCustomView",
								"selected": "overlap"
							})

							//move graph1
							d3.select("#graph0")
							.transition()
							.delay(500)
							.duration(500)
							.attr("transform","translate("+-(0)+","+margin_top+")");

							//move graph2
							d3.select("#graph1")
							.transition()
							.delay(500)
							.duration(500)
							.attr("transform","translate("+((margin_left*4)+dvc.panelWidth+dvc.panelGap)+","+margin_top+")");

							//move outline1
							d3.select("#outlines0")
							.transition()
							.delay(500)
							.duration(500)
							.attr("transform","translate("+(((dvc.xAdjust+dvc.panelWidth+dvc.panelGap)/2)+margin_left*0.75)+",0)");

							//move outline2
							d3.select("#outlines1")
							.transition()
							.delay(500)
							.duration(500)
							.attr("transform","translate(-"+(((dvc.xAdjust+dvc.panelWidth+dvc.panelGap)/2)+margin_left*0.75)+",0)");

							//dampen down main graphs
							d3.select("#panel0")
							.transition()
							.duration(100)
							.attr("opacity",0.7);

							d3.select("#panel1")
							.transition()
							.duration(100)
							.attr("opacity",0.7);

							d3.select("#intBars")
								.selectAll("rect")
								.attr("width",dvc.panelWidth)
								//.attr("x", - margin_left*2+(dvc.panelWidth)/2)
								.attr("x",((dvc.xAdjust+dvc.panelWidth+dvc.panelGap)/2)+margin_left*0.75)
						}
					updateHash();

		 }


		 function lockOutlines() {
					if (dvc.lockOutlines)
					{
						dvc.lockOutlines=false;
						d3.select("#outlinesButton").attr("aria-checked", false)
												//having unlocked the outlines, we now need to restore them to the current timeIndex
						modifyChart(0);
						modifyChart(1);
						//need to update text element to remove reference to outlinesa
							d3.select("#outlinesText0").select("text").text("")
							d3.select("#outlinesText1").select("text").text("")
							dvc.LockedYear = 'na';

							d3.select("#lockBtn").select("text").text(" lock outlines")
							d3.select("#lockBtn").select("span").attr("class", "glyphicon glyphicon-remove")

					}	else
					{
						dvc.lockOutlines=true;
						d3.select("#outlinesButton").attr("aria-checked", true)

						dataLayer.push({
								"event": "pyramidCustomView",
								"selected": "fix outline"
						})

						//need to update text element to say outlines are locked for a particular year

					d3.select("#outlinesText0").select("text").text("outline shows year "+dvc.data[0].ons.time.index[dvc.timeIndex])
					d3.select("#outlinesText1").select("text").text("outline shows year "+dvc.data[0].ons.time.index[dvc.timeIndex])
					dvc.LockedYear =  dvc.data[0].ons.time.index[dvc.timeIndex];

					d3.select("#lockBtn").select("text").text(" unlock outlines")
					d3.select("#lockBtn").select("span").attr("class","glyphicon glyphicon-ok")

					}
				updateHash();
			};


			function dimensions() {
				//identify selected dimenion

				if(dvc.varDimension=='0'){
					dvc.varDimension="1";
					d3.select("#dimensionsButton").attr("aria-checked", true)
					dataLayer.push({
						'event': 'pyramidCustomView',
						'selected': 'percentage'
					})

				} else {
					dvc.varDimension="0";
					d3.select("#dimensionsButton").attr("aria-checked", false)
					dataLayer.push({
						'event': 'pyramidCustomView',
						'selected': 'value'
					})
				}
				determineMax();
				redrawCharts();
			}

		 function tellMe(evt)
		{
			evt.preventDefault();//prevents  mobile browsers from pulling the screen while touching
			var myobj = d3.select(evt.target);

			if (evt.type=="mouseover")
			{
				if (dvc.selMade)
				{
				//do nothing, selection already made
				}	else
				{
					if (dvc.selProc)//build aggregate selection
					{
						//console.log(dvc.selEnd);
						dvc.selEnd=myobj.attr("data-nm");
						makeAlpha();
					}	else//just  single selection
					{
						myobj.attr("class","selected");
						//$("#changeables0").html("dfgdfgdfg")
						calcValues(0,myobj.attr("data-nm"));
						calcValues(1,myobj.attr("data-nm"));
						//console.log(myobj.attr("data-nm"))

					}
				}
			}

			if (evt.type=="mousedown")
			{
				if (dvc.selMade)
				{
				//do nothing, selection already made
				}	else//begin selection
				{
					dvc.selProc=true;
					dvc.selStart=myobj.attr("data-nm");
					dvc.selEnd=myobj.attr("data-nm");
					makeAlpha();
				}
			}//end mousedown

			if (evt.type=="mouseup")
			{
				if (dvc.selMade)
				{
					//do nothing, selection already made
				}	else
				{
					dvc.selMade=true;
					dvc.selProc=false;
					$( "#clearBtn" ).prop('disabled', false);
					calcValues(0,dvc.selStart,dvc.selEnd);
					calcValues(1,dvc.selStart,dvc.selEnd);
					updateHash();
				}
			}//end mouseup

			if (evt.type=="mouseout")
			{

				if (dvc.selMade)
				{

					//do nothing, selection made
				}	else
				{

					if (dvc.selProc==true)
					{
						//console.log('not doing anything, still selecting');
					}	else
					{
					$("#combinedTotal0").empty()
					$("#combinedTotal1").empty()

					myobj.attr("class","unselected")
					clearValues(0);
					clearValues(1);
					}

				}
			}//end mouseout


			//touch events
			if (evt.type=="touchstart")
			{
				if (dvc.selMade)
				{
					//do nothing, selection already made"
				}	else
				{
					myobj.attr("class","selected");
					//console.log('started touch on'+myobj.attr("data-nm"));
					calcValues(0,myobj.attr("data-nm"));
					calcValues(1,myobj.attr("data-nm"));
				}
			}//end touchstart

			if (evt.type=="touchmove")
			{

				if (dvc.selMade)
				{
					//do nothing, selection already made"
				}	else
				{
					//find the object under the touchmove event
					var touchX=evt.changedTouches[0].clientX;
					var touchY=evt.changedTouches[0].clientY;
					dvc.touchedElement=document.elementFromPoint(touchX,touchY);
					//gets at the object underneath the current x,y of finger
					var touchID=d3.select(dvc.touchedElement).attr("data-nm");
					var tagname=dvc.touchedElement.tagName;

					//make sure we are interacting with an interaction bar...
					if (tagname=="rect")
					{
						//don't start timer....we are building a selection....
						if (dvc.selProc==true)
						{
							dvc.selEnd=touchID;
							//console.log('building a selection to include '+touchID);
							makeAlpha();
						}	else//start timer....
						{
							//console.log('drifting over '+touchID);
							clearAlpha();
							clearTimeout(dvc.touchTimer);
							dvc.touchSel=touchID;
							dvc.touchTimer=setTimeout(aggSel,500);
							d3.select(dvc.touchedElement).attr("class","selected");
							calcValues(0,touchID);
							calcValues(1,touchID);
						}
					}//end interact with rect
				}
			}//end touchmove

			if (evt.type=="touchend")
			{
				if (dvc.selProc==true)
				{
					//complete the selection...
					dvc.selMade=true;
					$("#clearBtn" ).prop('disabled', false);
					dvc.selProc=false;
					calcValues(0,dvc.selStart,dvc.selEnd);
					calcValues(1,dvc.selStart,dvc.selEnd);
				}	else	//just a single mouseover selection being made...
				{
					dvc.touchSel=null;
					clearAlpha();
					clearTimeout(dvc.touchTimer);
				}
			updateHash();
			}
		}//end tellMe

		//trigger to build aggregate selection
		function aggSel()
		{
			dvc.selStart=dvc.touchSel;
			dvc.selEnd=dvc.touchSel;
			if (dvc.touchedElement.tagName=="rect")
			{
				d3.select(dvc.touchedElement).attr("class","highlighted");
			}
			dvc.selProc=true;
		}

		function makeAlpha()
		{	d3.select("#bar0_0").attr("width", "0px");
			d3.select("#bar1_0").attr("width", "0px");
			d3.select("#bar0_1").attr("width", "0px");
			d3.select("#bar1_1").attr("width", "0px");

			var loopSt=Math.min(dvc.selStart,dvc.selEnd);
			var loopEnd=Math.max(dvc.selStart,dvc.selEnd);
			//console.log(loopSt);
			$('#age0').html("building a selection..."+dvc.data[0].ons.dimension.index[loopSt]+":"+dvc.data[0].ons.dimension.index[loopEnd]);
			$('#age1').html("building a selection..."+dvc.data[1].ons.dimension.index[loopSt]+":"+dvc.data[1].ons.dimension.index[loopEnd]);



			//set all int bars to be unselected
			clearAlpha();
			//then filter the bars based on start/end points then change css
			d3.select("#intBars").selectAll("rect").filter(function(d, i) {
					return i>=loopSt&&i<=loopEnd;
			})
			.attr("class","selected");
		}

		function clearSel()
		{
				clearAlpha();
				clearValues(0);
				clearValues(1);
				dvc.selStart=null;
				dvc.selEnd=null;
				dvc.selMade=false;
				dvc.selProc=false;
				$( "#clearBtn" ).prop('disabled', true);
				updateHash();

		}

		function clearAlpha()
		{
			d3.select("#intBars").selectAll("rect")
				.attr("class","unselected");
		}

		function calcValues(chartNo,int1,int2)
		{
		if (typeof int2 === 'undefined') { int2 = int1; }

			var mystring;
			if (int1!=int2)
			{

				//multi selection
				var loopSt=Math.min(dvc.selStart,dvc.selEnd);
				var loopEnd=Math.max(dvc.selStart,dvc.selEnd);

				//initialise totals
				var totalM=0;
				var totalF=0;
				var total=0;

				//seriesM, get series for selected bars
				var selectionM = $(dvc.data[chartNo].ons.value[0]).filter(function (index){
					return index>=loopSt&&index<=loopEnd;
				});

				//calculate total for series M for current timeindex
				$(selectionM).each(function ()	{
					totalM=totalM+this[dvc.timeIndex][0];
				});

				//seriesF, get series for selected bars
				var selectionF = $(dvc.data[chartNo].ons.value[1]).filter(function (index){
					return index>=loopSt&&index<=loopEnd;
				});

				//calculate total for series F for current timeindex
				$(selectionF).each(function ()	{
					totalF=totalF+this[dvc.timeIndex][0];
				});

				//combined total for the current time period from both series
				total=totalM+totalF;
				overallTotal=(dvc.data[chartNo].ons.sums.series1[dvc.timeIndex])+(dvc.data[chartNo].ons.sums.series2[dvc.timeIndex])

				perOfTot=total/overallTotal;
				perM=totalM/total;
				perF=totalF/total;
					//console.log("perM :"+perM+"  perF: "+perF)
				//console.log(total);
				var combSeries=[];

				//and a combined time series for the aggregated cells
				for( var i = 0; i < dvc.timeLength; i++)
				{
				var seriesTotal=0;
				for (var j=0;j<selectionM.length;j++)
				{
					seriesTotal=seriesTotal+parseFloat(selectionM[j][i])+parseFloat(selectionF[j][i]);
				}
				  combSeries.push(seriesTotal);
				}



				var myFormat=d3.format("0,000");
				var myPercent = d3.format(".1%");
				var roundedTotal= Math.round(total/dvc.roundTo)*dvc.roundTo;
				var roundedTotalM= Math.round(totalM/dvc.roundTo)*dvc.roundTo;
				var roundedTotalF= Math.round(totalF/dvc.roundTo)*dvc.roundTo;
				//console.log(total+"  "+roundedTotal);
				//build up a string for text on page
				age="<span id='age' class='col-sm-12 col-xs-12'>"+dvc.data[chartNo].ons.dimension.label+" "+dvc.data[chartNo].ons.dimension.index[loopSt]+" to "+dvc.data[chartNo].ons.dimension.index[loopEnd]+"</span>"

				Values = "<span id='infobold'>" + myFormat(roundedTotalM) +"</span> males"+"<br><span id='infobold'>" + myFormat(roundedTotalF) +"</span> females";

				Percent = myPercent(perM)+ "<br>" +myPercent(perF)

				combined="<span id='infobold'>" + myFormat(roundedTotal)+"</span> people ("+myPercent(perOfTot)+" of total population)";

				dataArray=[ perM*200, perF*200]

			ageSelect = dvc.data[chartNo].ons.dimension.index[loopSt]+" to "+dvc.data[chartNo].ons.dimension.index[loopEnd]

			dataLayer.push({
				'event': 'pyramidAgeSelect',
				'selected': ageSelect
			})


			}	else if(int1 != null)
			{ 	//just a single selection
				var malesAgeTimeNum=dvc.data[chartNo].ons.value[0][int1][dvc.timeIndex][0];
				var femalesAgeTimeNum=dvc.data[chartNo].ons.value[1][int1][dvc.timeIndex][0];


				var malesAgeTimeNumRound=Math.round((dvc.data[chartNo].ons.value[0][int1][dvc.timeIndex][0])/dvc.roundTo)*dvc.roundTo;
				var femalesAgeTimeNumRound=Math.round((dvc.data[chartNo].ons.value[1][int1][dvc.timeIndex][0])/dvc.roundTo)*dvc.roundTo;
				if(malesAgeTimeNum+femalesAgeTimeNum==0){
					var permalesAgeTimeNum = 0;
					var perfemalesAgeTimeNum = 0;
				} else {
					var permalesAgeTimeNum = malesAgeTimeNum/(malesAgeTimeNum+femalesAgeTimeNum);
					var perfemalesAgeTimeNum = femalesAgeTimeNum/(malesAgeTimeNum+femalesAgeTimeNum);
				}

				var myTotal=(dvc.data[chartNo].ons.sums.series1[dvc.timeIndex])+(dvc.data[chartNo].ons.sums.series2[dvc.timeIndex]);

				var myAgeTotal=Math.round(((dvc.data[chartNo].ons.value[0][int1][dvc.timeIndex][0])+(dvc.data[chartNo].ons.value[1][int1][dvc.timeIndex][0]))/dvc.roundTo)*dvc.roundTo;
				var myPerAgeTotal=myAgeTotal/myTotal;

				var myFormat=d3.format("0,000");
				var myPercent = d3.format(".1%");

				age="<span id='age class='col-sm-3'>"+dvc.data[chartNo].ons.dimension.label+" "+dvc.data[0].ons.dimension.index[int1]+"</span>"

				Values = "<span id='infobold'>" + myFormat(malesAgeTimeNumRound) +"</span> males"+"<br><span id='infobold'>" + myFormat(femalesAgeTimeNumRound) +"</span> females";



				Percent =myPercent(permalesAgeTimeNum)+ "<br>" +myPercent(perfemalesAgeTimeNum)

				combined= "<span id='infobold'>" + myFormat(myAgeTotal)+"</span> people ("+ myPercent(myPerAgeTotal)+" of total population)"


				dataArray=[ permalesAgeTimeNum*200, perfemalesAgeTimeNum*200]

				//full series for series 1 and series 2:
				//dvc.data.series1[int1];
				//dvc.data.series2[int1];
			} else {

				var myFormat=d3.format("0,000");
				var myTotalM=myFormat(Math.round((dvc.data[chartNo].ons.sums.series1[dvc.timeIndex])/dvc.roundTo)*dvc.roundTo);
				var myTotalF=myFormat(Math.round((dvc.data[chartNo].ons.sums.series2[dvc.timeIndex])/dvc.roundTo)*dvc.roundTo);

				var myFormatPer=d3.format(".1%");
				var myPerM=(dvc.data[chartNo].ons.sums.series1[dvc.timeIndex]/((dvc.data[chartNo].ons.sums.series1[dvc.timeIndex])+(dvc.data[chartNo].ons.sums.series2[dvc.timeIndex])));
				var myPerF=(dvc.data[chartNo].ons.sums.series2[dvc.timeIndex]/((dvc.data[chartNo].ons.sums.series1[dvc.timeIndex])+(dvc.data[chartNo].ons.sums.series2[dvc.timeIndex])));

				age="<span id='age'> All ages </span>";
				Values = "<span id='infobold'>" + myTotalM +"</span> males"+"<br>" +"<span id='infobold'>" + myTotalF+"</span> females";

				//infoValues.html("<span id='infobold'>" + myTotalM +"</span> males<span></span>"+"<br>" +"<span id='infobold'>" + myTotalF+" females</span>")

				Percent = myFormatPer(myPerM) + "<br>" + myFormatPer(myPerF)
				//console.log(myPerM+ "  "+myPerF);

				combined = "";
				dataArray = [ myPerM*200 , myPerF*200 ];

			}
			//console.log(Percent)
			//console.log(Values);
			//update bar values
			d3.select("#bar0_"+chartNo).attr("width", dataArray[0]);
			d3.select("#bar1_"+chartNo).attr("width", dataArray[1]);


			//update text values in panel
			if(dvc.timeIndex==0 && dvc.nodata.indexOf(dvc.settings.config.vars[dvc.defaultSelections[chartNo]][1]) != -1){
				d3.select("#age"+chartNo).html("No data available");
				d3.select("#infoValues"+chartNo).html("");
				d3.select("#infoPercent"+chartNo).html("");
				d3.select("#combinedTotal"+chartNo).html("");
			} else if(dvc.timeIndex==0 && dvc.scotland.indexOf(dvc.settings.config.vars[dvc.defaultSelections[chartNo]][1]) == -1 && dvc.ageover85.indexOf(age.substring( age.lastIndexOf(" ")+1, age.lastIndexOf("</"))) != -1){
				d3.select("#age"+chartNo).html("No data at single year of age above 84");
				d3.select("#infoValues"+chartNo).html("");
				d3.select("#infoPercent"+chartNo).html("");
				d3.select("#combinedTotal"+chartNo).html("");
			} else {
				d3.select("#age"+chartNo).html(age);
				d3.select("#infoValues"+chartNo).html(Values);
				d3.select("#infoPercent"+chartNo).html(Percent);
				d3.select("#combinedTotal"+chartNo).html(combined)
			}




			}

		function clearValues(chartNo)
		{
			var myFormat=d3.format("0,000");
			var myPercent=d3.format("0.3p");
			var myTotalM=myFormat(Math.round((dvc.data[chartNo].ons.sums.series1[dvc.timeIndex])/dvc.roundTo)*dvc.roundTo);
			var myTotalF=myFormat(Math.round((dvc.data[chartNo].ons.sums.series2[dvc.timeIndex])/dvc.roundTo)*dvc.roundTo);
			var myPerM=(dvc.data[chartNo].ons.sums.series1[dvc.timeIndex]/(dvc.data[chartNo].ons.sums.series1[dvc.timeIndex]+dvc.data[chartNo].ons.sums.series2[dvc.timeIndex]))
			var myPerF=(dvc.data[chartNo].ons.sums.series2[dvc.timeIndex]/(dvc.data[chartNo].ons.sums.series1[dvc.timeIndex]+dvc.data[chartNo].ons.sums.series2[dvc.timeIndex]))

			if(dvc.timeIndex==0 && dvc.nodata.indexOf(dvc.settings.config.vars[dvc.defaultSelections[chartNo]][1]) != -1){
				d3.select("#age"+chartNo).html("<span id='age' class='col-sm-4'> No data available</span>")
				d3.select("#infoValues"+chartNo).html("");
				d3.select("#infoPercent"+chartNo).html("");
			} /*else if(dvc.timeIndex==0 && dvc.scotland.indexOf(dvc.settings.config.vars[dvc.defaultSelections[chartNo]][1]) == -1 && dvc.ageover85.indexOf(age.substring(age.lastIndexOf("e ")+1, age.lastIndexOf("</"))) == -1){
				d3.select("#age"+chartNo).html("sdfsdfNo data at single year of age above 84");
				d3.select("#infoValues"+chartNo).html("");
				d3.select("#infoPercent"+chartNo).html("");
				d3.select("#combinedTotal"+chartNo).html("");
			}*/ else {
				d3.select("#age"+chartNo).html("<span id='age' class='col-sm-4'> All ages</span>")
				d3.select("#infoValues"+chartNo).html("<span id='infobold'>" + myTotalM +"</span> males<span></span>"+"<br>" +"<span id='infobold'>" + myTotalF+"</span> females");
				d3.select("#infoPercent"+chartNo).html(myPercent(myPerM)+ " <br>"+ myPercent(myPerF));
			}

			d3.select("#bar0_"+chartNo).attr("width", myPerM*200);
			d3.select("#bar1_"+chartNo).attr("width", myPerF*200);

		}


	// $(window).resize(function () {

	// 	bodywidth = d3.select("body").style("width")
	// 	bwidth = bodywidth.replace('px', '');

	// 		if(bwidth>767){
	// 			d3.select("#vizCanvas").attr("viewBox", "0, 0, 1000, 500")
	// 			d3.select("#graph1").attr("class", "show")
	// 		} else {
	// 			d3.select("#vizCanvas").attr("viewBox", "0, 0, 500, 500")
	// 			d3.select("#graph1").attr("class", "invisible")
	// 		}
	// });







	 function updateHash() {


	   window.location.hash = encodeURI(dvc.timeIndex + "/" + dvc.defaultSelections[0] + "/" + dvc.defaultSelections[1] + "/" + dvc.selStart + "/" + dvc.selEnd + "/" + dvc.overlap + "/" + dvc.lockOutlines + "/" + dvc.LockedYear + "/" + dvc.varDimension);

	//console.log(window.location.hash)
	}











		//check whether browser can cope with svg
		if (Modernizr.svg) {

				var url = decodeURI(window.location.hash);
				params = url.split("/");

			//load config
			d3.json("config.json", function(json)	{
						dvc.settings=json;

						dvc.timeLength=dvc.settings.config.timeSeries;
						dvc.timeMin=dvc.settings.config.timeMinMax[0];
						dvc.timeMax=dvc.settings.config.timeMinMax[1];

				if(url != "") { //if parameters set in url
						dvc.timeIndex=params[0].split("#")[1];
						dvc.defaultSelections=[params[1],params[2]]
						if (params[3]=='null'){
							dvc.selStart =	null;
						} else {
							dvc.selStart =	params[3];
						}
						if (params[4] =='null'){
							dvc.selEnd = null;
						} else {
							dvc.selEnd =	params[4];
						}

						if(params[5]=='false'){
							dvc.overlap = false;
							$('#overlapToggle').prop('checked', false).change()
						} else {
							dvc.overlap = true;
							$('#overlapToggle').prop('checked', true).change()
						}
						if(params[6]=='false'){
							dvc.lockOutlines = false;
						} else {
							dvc.lockOutlines = true;
						}
						dvc.LockedYear =	params[7];
						//dvc.outlineIndex = dvc.data[0].ons.time.index.indexOf(dvc.LockedYear);
						dvc.varDimension=params[8];
						if(params[1]!= null & params[2]!= null) {
								dvc.selMade=true;
						}
				} else {
						//if no parameters set in url
						dvc.timeIndex=dvc.settings.config.timeDefault;//assign default starting period
						dvc.defaultSelections=dvc.settings.config.defaultVars;
						dvc.selStart =	null;
						dvc.selEnd 	= null;
						dvc.overlap =	false;
						dvc.lockOutlines =	false;
						dvc.LockedYear = 'na';
						dvc.outlineIndex ='na';
						dvc.varDimension=dvc.settings.config.defaultConcept;//used to switch between count and % data elements
						$('#overlapToggle').prop('checked', false).change()

				}

						//declare an array to hold the 2 graph datasets
						dvc.data=new Array();

						//load the first data file as specified in the config
						d3.json("data/"+dvc.settings.config.vars[dvc.defaultSelections[0]][0], function(data) {
							dvc.data[0]=data;//assign the first file's data to our dvc data...

							//...then load our second data file
							d3.json("data/"+dvc.settings.config.vars[dvc.defaultSelections[1]][0], function(data) {
								dvc.data[1]=data;//now assign our second data file to the dvc data arrays

						//use pym to create iframed chart dependent on specified variables
						pymChild = new pym.Child({ renderCallback: drawGraphic});

							});//end second dataset load

						});//end first dataset load


			})//end config load

		} else {
			 //use pym to create iframe containing fallback image (which is set as default)
			 pymChild = new pym.Child();
			if (pymChild) {
		        pymChild.sendHeight();
		    }
		}
    </script>
    <script>

		  /* Analytics */

		  /* Google */
		  var _gaq = _gaq || [];
		  _gaq.push(['_setAccount', 'UA-37894017-1']);
		  _gaq.push(['_trackPageview']);


		  (function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		  })();


    </script>
</body>
</html>
